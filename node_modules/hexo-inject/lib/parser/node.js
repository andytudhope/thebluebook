'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Document = exports.InjectionBlock = exports.Block = exports.default = undefined;

var _typeof = typeof Symbol === "function" && typeof Symbol.iterator === "symbol" ? function (obj) { return typeof obj; } : function (obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol ? "symbol" : typeof obj; };

var _get = function get(object, property, receiver) { if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { return get(parent, property, receiver); } } else if ("value" in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

exports.wrap = wrap;

var _underscore = require('underscore');

var _underscore2 = _interopRequireDefault(_underscore);

var _crypto = require('crypto');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function wrap(type, content) {
  // If content is another token, clone it and change the type
  if (_underscore2.default.isObject(content) && _underscore2.default.isString(content.type)) {
    content = _underscore2.default.clone(content);
    content.type = type;
    return content;
  }
  // Wrap as token
  return {
    type: type,
    content: content
  };
}

var Node = function () {
  function Node(type) {
    _classCallCheck(this, Node);

    this.type = type;
    this.children = [];
  }

  _createClass(Node, [{
    key: 'prepend',
    value: function prepend(content) {
      // if (_.isArray(content)) return content.forEach(this.prepend.bind(this))
      this.children.unshift(content);
    }
  }, {
    key: 'append',
    value: function append(content) {
      // if (_.isArray(content)) return content.forEach(this.append.bind(this))
      this.children.push(content);
    }
  }, {
    key: 'clear',
    value: function clear() {
      this.children = [];
    }
  }, {
    key: 'content',
    get: function get() {
      return this.children.map(function (c) {
        return c.content;
      }).join('');
    }
  }, {
    key: 'firstChild',
    get: function get() {
      return this.children.length === 0 ? null : this.children[0];
    }
  }, {
    key: 'lastChild',
    get: function get() {
      return this.children.length === 0 ? null : this.children[this.children.length - 1];
    }
  }]);

  return Node;
}();

exports.default = Node;

var Block = exports.Block = function (_Node) {
  _inherits(Block, _Node);

  _createClass(Block, null, [{
    key: 'make',
    value: function make(type, begin, end) {
      var T = Block.TYPES[type];
      return T ? new T(begin, end) : new Block(type, begin, end);
    }
  }]);

  function Block(type, begin, end) {
    _classCallCheck(this, Block);

    var _this = _possibleConstructorReturn(this, Object.getPrototypeOf(Block).call(this, type || 'block'));

    _this.begin = begin;
    _this.end = end;
    return _this;
  }

  _createClass(Block, [{
    key: 'validate',
    value: function validate() {
      if (this.children.length <= 2) return true;
      for (var i = 1; i < this.children.length - 1; i++) {
        if (this.children[i].type === 'injection') return false;
      }
      return true;
    }
  }, {
    key: 'injectBefore',
    value: function injectBefore(content) {
      var firstChild = this.firstChild;
      if (firstChild === null || firstChild.type !== 'injection') {
        firstChild = new InjectionBlock();
        this.prepend(firstChild);
      }
      firstChild.append(content);
    }
  }, {
    key: 'injectAfter',
    value: function injectAfter(content) {
      var lastChild = this.lastChild;
      if (lastChild === null || lastChild.type !== 'injection') {
        lastChild = new InjectionBlock();
        this.append(lastChild);
      }
      lastChild.append(content);
    }
  }, {
    key: 'clearInjections',
    value: function clearInjections() {
      var firstChild = this.firstChild;
      var lastChild = this.lastChild;

      if (firstChild !== null && firstChild.type === 'injection') firstChild.clear();
      if (lastChild !== null && lastChild.type === 'injection') lastChild.clear();
    }
  }, {
    key: 'content',
    get: function get() {
      return this.begin.content + _get(Object.getPrototypeOf(Block.prototype), 'content', this) + this.end.content;
    }
  }]);

  return Block;
}(Node);

var INJECTION_BEGIN = wrap('injection_begin', '<!-- hexo-inject:begin -->');
var INJECTION_END = wrap('injection_end', '<!-- hexo-inject:end -->');

var InjectionBlock = exports.InjectionBlock = function (_Block) {
  _inherits(InjectionBlock, _Block);

  function InjectionBlock() {
    var begin = arguments.length <= 0 || arguments[0] === undefined ? INJECTION_BEGIN : arguments[0];
    var end = arguments.length <= 1 || arguments[1] === undefined ? INJECTION_END : arguments[1];

    _classCallCheck(this, InjectionBlock);

    var _this2 = _possibleConstructorReturn(this, Object.getPrototypeOf(InjectionBlock).call(this, 'injection', begin, end));

    _this2._contentHash = {};
    return _this2;
  }

  _createClass(InjectionBlock, [{
    key: '_ensureUniqueContent',
    value: function _ensureUniqueContent(node) {
      var hasher = (0, _crypto.createHash)('md5');
      var content = node.content;

      hasher.update(content);
      var hash = hasher.digest('hex');
      if (this._contentHash[hash]) return false;
      this._contentHash[hash] = node;
      return true;
    }
  }, {
    key: 'prepend',
    value: function prepend(content) {
      if (_underscore2.default.isArray(content)) return content.forEach(this.prepend.bind(this));
      content = wrap('injection_text', content);
      if (this._ensureUniqueContent(content)) _get(Object.getPrototypeOf(InjectionBlock.prototype), 'prepend', this).call(this, content);
    }
  }, {
    key: 'append',
    value: function append(content) {
      if (_underscore2.default.isArray(content)) return content.forEach(this.append.bind(this));
      content = wrap('injection_text', content);
      if (this._ensureUniqueContent(content)) _get(Object.getPrototypeOf(InjectionBlock.prototype), 'append', this).call(this, content);
    }
  }, {
    key: 'injectBefore',
    value: function injectBefore(content) {
      this.prepend(content);
    }
  }, {
    key: 'injectAfter',
    value: function injectAfter(content) {
      this.append(content);
    }
  }, {
    key: 'clear',
    value: function clear() {
      _get(Object.getPrototypeOf(InjectionBlock.prototype), 'clear', this).call(this);
      this._contentHash = {};
    }
  }]);

  return InjectionBlock;
}(Block);

Block.TYPES = {
  'injection': InjectionBlock
};

var Document = exports.Document = function (_Node2) {
  _inherits(Document, _Node2);

  function Document() {
    _classCallCheck(this, Document);

    return _possibleConstructorReturn(this, Object.getPrototypeOf(Document).call(this, 'document'));
  }

  _createClass(Document, [{
    key: 'head',
    get: function get() {
      return this.children.find(function (_ref) {
        var type = _ref.type;
        return type === 'head';
      });
    }
  }, {
    key: 'body',
    get: function get() {
      return this.children.find(function (_ref2) {
        var type = _ref2.type;
        return type === 'body';
      });
    }
  }, {
    key: 'isComplete',
    get: function get() {
      return _typeof(this.head) === 'object' && _typeof(this.body) === 'object';
    }
  }]);

  return Document;
}(Node);
//# sourceMappingURL=data:application/json;base64,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WCxXQURXLFFBQ1gsR0FBZTswQkFESixVQUNJOztrRUFESixxQkFFSCxhQURPO0dBQWY7O2VBRFc7O3dCQUlDO0FBQ1YsYUFBTyxLQUFLLFFBQUwsQ0FBYyxJQUFkLENBQW1CO1lBQUc7ZUFBVyxTQUFTLE1BQVQ7T0FBZCxDQUExQixDQURVOzs7O3dCQUdBO0FBQ1YsYUFBTyxLQUFLLFFBQUwsQ0FBYyxJQUFkLENBQW1CO1lBQUc7ZUFBVyxTQUFTLE1BQVQ7T0FBZCxDQUExQixDQURVOzs7O3dCQUdNO0FBQ2hCLGFBQU8sUUFBTyxLQUFLLElBQUwsQ0FBUCxLQUFxQixRQUFyQixJQUFpQyxRQUFPLEtBQUssSUFBTCxDQUFQLEtBQXFCLFFBQXJCLENBRHhCOzs7O1NBVlA7RUFBaUIiLCJmaWxlIjoicGFyc2VyL25vZGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICd1bmRlcnNjb3JlJ1xyXG5pbXBvcnQgeyBjcmVhdGVIYXNoIH0gZnJvbSAnY3J5cHRvJ1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHdyYXAgKHR5cGUsIGNvbnRlbnQpIHtcclxuICAvLyBJZiBjb250ZW50IGlzIGFub3RoZXIgdG9rZW4sIGNsb25lIGl0IGFuZCBjaGFuZ2UgdGhlIHR5cGVcclxuICBpZiAoXy5pc09iamVjdChjb250ZW50KSAmJiBfLmlzU3RyaW5nKGNvbnRlbnQudHlwZSkpIHtcclxuICAgIGNvbnRlbnQgPSBfLmNsb25lKGNvbnRlbnQpXHJcbiAgICBjb250ZW50LnR5cGUgPSB0eXBlXHJcbiAgICByZXR1cm4gY29udGVudFxyXG4gIH1cclxuICAvLyBXcmFwIGFzIHRva2VuXHJcbiAgcmV0dXJuIHtcclxuICAgIHR5cGUsXHJcbiAgICBjb250ZW50XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBOb2RlIHtcclxuICBjb25zdHJ1Y3RvciAodHlwZSkge1xyXG4gICAgdGhpcy50eXBlID0gdHlwZVxyXG4gICAgdGhpcy5jaGlsZHJlbiA9IFtdXHJcbiAgfVxyXG4gIGdldCBjb250ZW50ICgpIHtcclxuICAgIHJldHVybiB0aGlzLmNoaWxkcmVuLm1hcCgoYykgPT4gYy5jb250ZW50KS5qb2luKCcnKVxyXG4gIH1cclxuICBnZXQgZmlyc3RDaGlsZCAoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5jaGlsZHJlbi5sZW5ndGggPT09IDAgPyBudWxsIDogdGhpcy5jaGlsZHJlblswXVxyXG4gIH1cclxuICBnZXQgbGFzdENoaWxkICgpIHtcclxuICAgIHJldHVybiB0aGlzLmNoaWxkcmVuLmxlbmd0aCA9PT0gMCA/IG51bGwgOiB0aGlzLmNoaWxkcmVuW3RoaXMuY2hpbGRyZW4ubGVuZ3RoIC0gMV1cclxuICB9XHJcbiAgcHJlcGVuZCAoY29udGVudCkge1xyXG4gICAgLy8gaWYgKF8uaXNBcnJheShjb250ZW50KSkgcmV0dXJuIGNvbnRlbnQuZm9yRWFjaCh0aGlzLnByZXBlbmQuYmluZCh0aGlzKSlcclxuICAgIHRoaXMuY2hpbGRyZW4udW5zaGlmdChjb250ZW50KVxyXG4gIH1cclxuICBhcHBlbmQgKGNvbnRlbnQpIHtcclxuICAgIC8vIGlmIChfLmlzQXJyYXkoY29udGVudCkpIHJldHVybiBjb250ZW50LmZvckVhY2godGhpcy5hcHBlbmQuYmluZCh0aGlzKSlcclxuICAgIHRoaXMuY2hpbGRyZW4ucHVzaChjb250ZW50KVxyXG4gIH1cclxuICBjbGVhciAoKSB7XHJcbiAgICB0aGlzLmNoaWxkcmVuID0gW11cclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBCbG9jayBleHRlbmRzIE5vZGUge1xyXG4gIHN0YXRpYyBtYWtlICh0eXBlLCBiZWdpbiwgZW5kKSB7XHJcbiAgICBsZXQgVCA9IEJsb2NrLlRZUEVTW3R5cGVdXHJcbiAgICByZXR1cm4gVCA/IG5ldyBUKGJlZ2luLCBlbmQpIDogbmV3IEJsb2NrKHR5cGUsIGJlZ2luLCBlbmQpXHJcbiAgfVxyXG4gIGNvbnN0cnVjdG9yICh0eXBlLCBiZWdpbiwgZW5kKSB7XHJcbiAgICBzdXBlcih0eXBlIHx8ICdibG9jaycpXHJcbiAgICB0aGlzLmJlZ2luID0gYmVnaW5cclxuICAgIHRoaXMuZW5kID0gZW5kXHJcbiAgfVxyXG4gIGdldCBjb250ZW50ICgpIHtcclxuICAgIHJldHVybiB0aGlzLmJlZ2luLmNvbnRlbnQgKyBzdXBlci5jb250ZW50ICsgdGhpcy5lbmQuY29udGVudFxyXG4gIH1cclxuICB2YWxpZGF0ZSAoKSB7XHJcbiAgICBpZiAodGhpcy5jaGlsZHJlbi5sZW5ndGggPD0gMikgcmV0dXJuIHRydWVcclxuICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdGhpcy5jaGlsZHJlbi5sZW5ndGggLSAxOyBpKyspIHtcclxuICAgICAgaWYgKHRoaXMuY2hpbGRyZW5baV0udHlwZSA9PT0gJ2luamVjdGlvbicpIHJldHVybiBmYWxzZVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHRydWVcclxuICB9XHJcbiAgaW5qZWN0QmVmb3JlIChjb250ZW50KSB7XHJcbiAgICBsZXQgZmlyc3RDaGlsZCA9IHRoaXMuZmlyc3RDaGlsZFxyXG4gICAgaWYgKGZpcnN0Q2hpbGQgPT09IG51bGwgfHwgZmlyc3RDaGlsZC50eXBlICE9PSAnaW5qZWN0aW9uJykge1xyXG4gICAgICBmaXJzdENoaWxkID0gbmV3IEluamVjdGlvbkJsb2NrKClcclxuICAgICAgdGhpcy5wcmVwZW5kKGZpcnN0Q2hpbGQpXHJcbiAgICB9XHJcbiAgICBmaXJzdENoaWxkLmFwcGVuZChjb250ZW50KVxyXG4gIH1cclxuICBpbmplY3RBZnRlciAoY29udGVudCkge1xyXG4gICAgbGV0IGxhc3RDaGlsZCA9IHRoaXMubGFzdENoaWxkXHJcbiAgICBpZiAobGFzdENoaWxkID09PSBudWxsIHx8IGxhc3RDaGlsZC50eXBlICE9PSAnaW5qZWN0aW9uJykge1xyXG4gICAgICBsYXN0Q2hpbGQgPSBuZXcgSW5qZWN0aW9uQmxvY2soKVxyXG4gICAgICB0aGlzLmFwcGVuZChsYXN0Q2hpbGQpXHJcbiAgICB9XHJcbiAgICBsYXN0Q2hpbGQuYXBwZW5kKGNvbnRlbnQpXHJcbiAgfVxyXG4gIGNsZWFySW5qZWN0aW9ucyAoKSB7XHJcbiAgICBsZXQgeyBmaXJzdENoaWxkLCBsYXN0Q2hpbGQgfSA9IHRoaXNcclxuICAgIGlmIChmaXJzdENoaWxkICE9PSBudWxsICYmIGZpcnN0Q2hpbGQudHlwZSA9PT0gJ2luamVjdGlvbicpIGZpcnN0Q2hpbGQuY2xlYXIoKVxyXG4gICAgaWYgKGxhc3RDaGlsZCAhPT0gbnVsbCAmJiBsYXN0Q2hpbGQudHlwZSA9PT0gJ2luamVjdGlvbicpIGxhc3RDaGlsZC5jbGVhcigpXHJcbiAgfVxyXG59XHJcblxyXG5jb25zdCBJTkpFQ1RJT05fQkVHSU4gPSB3cmFwKCdpbmplY3Rpb25fYmVnaW4nLCAnPCEtLSBoZXhvLWluamVjdDpiZWdpbiAtLT4nKVxyXG5jb25zdCBJTkpFQ1RJT05fRU5EICAgPSB3cmFwKCdpbmplY3Rpb25fZW5kJyAgLCAnPCEtLSBoZXhvLWluamVjdDplbmQgLS0+JylcclxuZXhwb3J0IGNsYXNzIEluamVjdGlvbkJsb2NrIGV4dGVuZHMgQmxvY2sge1xyXG4gIGNvbnN0cnVjdG9yIChiZWdpbiA9IElOSkVDVElPTl9CRUdJTiwgZW5kID0gSU5KRUNUSU9OX0VORCkge1xyXG4gICAgc3VwZXIoJ2luamVjdGlvbicsIGJlZ2luLCBlbmQpXHJcbiAgICB0aGlzLl9jb250ZW50SGFzaCA9IHt9XHJcbiAgfVxyXG4gIF9lbnN1cmVVbmlxdWVDb250ZW50IChub2RlKSB7XHJcbiAgICBsZXQgaGFzaGVyID0gY3JlYXRlSGFzaCgnbWQ1JylcclxuICAgIGxldCB7IGNvbnRlbnQgfSA9IG5vZGVcclxuICAgIGhhc2hlci51cGRhdGUoY29udGVudClcclxuICAgIGxldCBoYXNoID0gaGFzaGVyLmRpZ2VzdCgnaGV4JylcclxuICAgIGlmICh0aGlzLl9jb250ZW50SGFzaFtoYXNoXSkgcmV0dXJuIGZhbHNlXHJcbiAgICB0aGlzLl9jb250ZW50SGFzaFtoYXNoXSA9IG5vZGVcclxuICAgIHJldHVybiB0cnVlXHJcbiAgfVxyXG4gIHByZXBlbmQgKGNvbnRlbnQpIHtcclxuICAgIGlmIChfLmlzQXJyYXkoY29udGVudCkpIHJldHVybiBjb250ZW50LmZvckVhY2godGhpcy5wcmVwZW5kLmJpbmQodGhpcykpXHJcbiAgICBjb250ZW50ID0gd3JhcCgnaW5qZWN0aW9uX3RleHQnLCBjb250ZW50KVxyXG4gICAgaWYgKHRoaXMuX2Vuc3VyZVVuaXF1ZUNvbnRlbnQoY29udGVudCkpIHN1cGVyLnByZXBlbmQoY29udGVudClcclxuICB9XHJcbiAgYXBwZW5kIChjb250ZW50KSB7XHJcbiAgICBpZiAoXy5pc0FycmF5KGNvbnRlbnQpKSByZXR1cm4gY29udGVudC5mb3JFYWNoKHRoaXMuYXBwZW5kLmJpbmQodGhpcykpXHJcbiAgICBjb250ZW50ID0gd3JhcCgnaW5qZWN0aW9uX3RleHQnLCBjb250ZW50KVxyXG4gICAgaWYgKHRoaXMuX2Vuc3VyZVVuaXF1ZUNvbnRlbnQoY29udGVudCkpIHN1cGVyLmFwcGVuZChjb250ZW50KVxyXG4gIH1cclxuICBpbmplY3RCZWZvcmUgKGNvbnRlbnQpIHtcclxuICAgIHRoaXMucHJlcGVuZChjb250ZW50KVxyXG4gIH1cclxuICBpbmplY3RBZnRlciAoY29udGVudCkge1xyXG4gICAgdGhpcy5hcHBlbmQoY29udGVudClcclxuICB9XHJcbiAgY2xlYXIgKCkge1xyXG4gICAgc3VwZXIuY2xlYXIoKVxyXG4gICAgdGhpcy5fY29udGVudEhhc2ggPSB7fVxyXG4gIH1cclxufVxyXG5cclxuQmxvY2suVFlQRVMgPSB7XHJcbiAgJ2luamVjdGlvbic6IEluamVjdGlvbkJsb2NrXHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBEb2N1bWVudCBleHRlbmRzIE5vZGUge1xyXG4gIGNvbnN0cnVjdG9yICgpIHtcclxuICAgIHN1cGVyKCdkb2N1bWVudCcpXHJcbiAgfVxyXG4gIGdldCBoZWFkICgpIHtcclxuICAgIHJldHVybiB0aGlzLmNoaWxkcmVuLmZpbmQoKHsgdHlwZSB9KSA9PiB0eXBlID09PSAnaGVhZCcpXHJcbiAgfVxyXG4gIGdldCBib2R5ICgpIHtcclxuICAgIHJldHVybiB0aGlzLmNoaWxkcmVuLmZpbmQoKHsgdHlwZSB9KSA9PiB0eXBlID09PSAnYm9keScpXHJcbiAgfVxyXG4gIGdldCBpc0NvbXBsZXRlICgpIHtcclxuICAgIHJldHVybiB0eXBlb2YgdGhpcy5oZWFkID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgdGhpcy5ib2R5ID09PSAnb2JqZWN0J1xyXG4gIH1cclxufVxyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
